// A patch to the TRIGA engine from Interstellar Technologies, converting it into using SystemHeat mechanics, plus making it multimodal to give the option between thrust
// or specific impulse amplification.
// Depends on Interstellar Technologies for the engine model and texture, Kerbal atomics for nuclear engine waterfall plumes, SystemHeat for cooling mechanics and Waterfall
// for pretty looking plumes.
@PART[Interstellar-Technologies_TRIGA]:NEEDS[InterstellarTechnologies,KerbalAtomics,SystemHeat,Waterfall]
{
	// Remove all stuff configuring the engine for interstellar extended
	!MODULE[ModuleWaterfallFX]
	{
	}
	!MODULE[TweakScale]:HAS[#type[stack_interstellar]]
	{
	}
	!MODULE[ModuleEnginesFX]
	{
	}
	!MODULE[InterstellarFissionNTR]
	{
	}
	!MODULE[ThermalElectricEffectGenerator]
	{
	}
	!MODULE[ModuleGenerator]
	{
	}
	!MODULE[ThermalEngineController]
	{
	}
	!MODULE[ModuleGimbal]
	{
	}
	!RESOURCE[WasteHeat]
	{
	}
	!MODULE[FNWasteheatBuffer]
	{
	}
	!MODULE[FNWasteheatExplode]
	{
	}
	// add multimodality
	MODULE
	{
		name = MultiModeEngine
		primaryEngineID = PulsedThrust
		secondaryEngineID = PulsedIsp
		carryOverThrottle = False
	}
	// Re-add engine modules
	// Pulsed core, thrust amplification mode.
	MODULE
	{
		name = ModuleEnginesFX
		engineID = PulsedThrust
		thrustVectorTransformName = thrustTransform
		exhaustDamage = True
		ignitionThreshold = 0.03
		minThrust = 0
		maxThrust = 857.15 // realistic maximum thrust is 85715kN, but this is far too high to be reasonable given engine geometry and size - the nozzle would break
		heatProduction = 0
		useEngineResponseTime = True
		engineAccelerationSpeed = 10
		engineDecelerationSpeed = 10
		flameoutEffectName = flameout
		effectName = running_closed
		powerEffectName = Pulsed-Hi-Thrust
		engageEffectName = engage
		disengageEffectName = disengage
		// spoolEffectName = running_turbine
		engineSpoolIdle = 0.05
		engineSpoolTime = 2.0
		EngineType = Nuclear
		// exhaustDamageMultiplier = 600
		// exhaustDamageMaxRange = 20
		
		PROPELLANT
		{
			name = LqdHydrogen
			ratio = 1
			DrawGauge = True
		}
		atmosphereCurve
		{
			key = 0 950
			key = 1 232.5
			key = 2 0.001 0 0
		}
	}
	// Pulsed Core, Isp Amplification Mode
	MODULE
	{
		name = ModuleEnginesFX
		engineID = PulsedIsp
		thrustVectorTransformName = thrustTransform
		exhaustDamage = True
		ignitionThreshold = 0.03
		minThrust = 0
		maxThrust = 50
		heatProduction = 0
		useEngineResponseTime = True
		engineAccelerationSpeed = 10
		engineDecelerationSpeed = 10
		flameoutEffectName = flameout
		effectName = running_closed
		powerEffectName = Pulsed-HI-Isp
		engageEffectName = engage
		disengageEffectName = disengage
		// spoolEffectName = running_turbine
		engineSpoolIdle = 0.05
		engineSpoolTime = 2.0
		EngineType = Nuclear
		// exhaustDamageMultiplier = 600
		// exhaustDamageMaxRange = 20
		
		PROPELLANT
		{
			name = LqdHydrogen
			ratio = 1
			DrawGauge = True
		}
		atmosphereCurve
		{
			key = 0 9068.64
			key = 1 50
			key = 2 0.001 0 0
		}
	}
	// attempt at using near future propulsion's variable Isp engine module to emmulate scalable thrust and Isp. Removed due to not scaling systemheat requirements.
//	MODULE:NEEDS[NearFuturePropulsion]
//	{
//		name = VariableISPEngine
//		EnergyUsage = 0.0001
//		UseDirectThrottle = false
//		CurThrustSetting = 50
//		VARIABLEISPMODE
//		{
//			name = PulsedThrust
//			IspThrustCurve
//			{
//				key = 950 50
//				key = 950.001 85715
//			}
//		}
//		VARIABLEISPMODE
//		{
//			name = PulsedIsp
//			IspThrustCurve
//			{
//				key = 950 50
//				key = 9068.64 50.001
//			}
//		}
//	}
	// attempt at using NFP's variable power engine module to emmulate selectable Isp. Removed due to inability to link an engineID to it.
//	MODULE
//	{
//		name = VariablePowerEngine
//		ConstantThrust = 50
//		HeatCurve
//		{
//			key = 0 0
//			key = 1 50000
//		}
//		PowerCurve
//		{
//			key = 0 0.001
//			key = 1 0.002
//		}
//		IspCurve
//		{
//			key = 0 950
//			key = 1 9068.64
//		}
//	}
	// SystemHeat modules
	MODULE
	{
		name = ModuleSystemHeat
		// Cubic metres
		volume = 3.4
		moduleID = reactor
		iconName = Icon_Nuclear
	}
	MODULE
	{
		name = ModuleSystemHeatEngine
		// must be unique
		moduleID = engine
		// ModuleSystemHeat to link to
		systemHeatModuleID = reactor
		engineModuleID = PulsedThrust

		// in KW at peak output
		systemPower = 210140.984713 // max thrust reduced by 100x, 21014098.4713 kilowatt waste engine power is reduced accordingly to 210140.984713 kilowatts
		// System shutdown temperature
		shutdownTemperature = 2000
		// Nominal system output temperature
		systemOutletTemperature = 1600
		// Valid system temperature range
		temperatureCurve
		{
			key = 0 1.0
			key = 1600 1.0
			key = 2000 0.0
		}
	}
	MODULE
	{
		name = ModuleSystemHeatEngine
		// must be unique
		moduleID = engine2
		// ModuleSystemHeat to link to
		systemHeatModuleID = reactor
		engineModuleID = PulsedIsp

		// in KW at peak output
		systemPower = 399034.963017 // realistic value 399034963.017 kilowatts, lowered by 1000x for playability
		// System shutdown temperature
		shutdownTemperature = 3200
		// Nominal system output temperature
		systemOutletTemperature = 2500 // realistic upper limit on radiator temperature - carbon-carbon composite or graphene radiator surface, with zirconium carbide cooling pipes and liquid beryllium coolant, using phase-change cooling to increase maximum temperature
		// Valid system temperature range
		temperatureCurve
		{
			key = 0 1.0
			key = 2500 1.0
			key = 3200 0.0
		}
	}
	// I attempted to add SystemHeatFissionEngines compatibility, but the game gives me null references
	RESOURCE
	{
		name = DepletedFuel
		amount = 0
		maxAmount = 12
		isTweakable = False
	}
	// Waterfall Modules
	// Pulsed core, high thrust plume
	MODULE
	{
		name = ModuleWaterfallFX
		moduleID = TRIGAHighThrust
		engineID = PulsedThrust
		CONTROLLER
		{
			name = atmosphereDepth
			linkedTo = atmosphere_density
		}
		CONTROLLER
		{
			name = throttle
			linkedTo = throttle
			engineID = PulsedThrust
		}
		CONTROLLER
		{
			name = random
			linkedTo = random
			range = -1,1
		}
		TEMPLATE
		{
			// Since it has normal Isp, makes sese to use the default, solid core fission engine plume
			templateName = waterfall-ka-ntr-lh2-1
			overrideParentTransform = thrustTransform
			position = 0,0,-0.022
			rotation = 0, 0, 0
			scale = 0.85, 0.85, 2
		}
	}
	// Pulsed Core, High Isp
	MODULE
	{
		name = ModuleWaterfallFX
		moduleID = TRIGAHighIsp
		engineID = PulsedIsp
		CONTROLLER
		{
			name = atmosphereDepth
			linkedTo = atmosphere_density
		}
		CONTROLLER
		{
			name = throttle
			linkedTo = throttle
			engineID = PulsedIsp
		}
		CONTROLLER
		{
			name = random
			linkedTo = random
			range = -1,1
		}
		TEMPLATE
		{
			// use the open cycle gas core template because the temperatures are high enough.
			templateName = waterfall-ka-ntr-lh2-3
			overrideParentTransform = thrustTransform
			position = 0,0,-0.022
			rotation = 0, 0, 0
			scale = 0.85, 0.85, 2
		}
	}
}
